name: Deploy Hugo Site to GitHub Pages

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  lint-and-validate:
    runs-on: ubuntu-latest
    outputs:
      validation_passed: ${{ steps.validate.outputs.passed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Python for validation
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install validation tools
        run: |
          pip install yamllint
          pip install frontmatter

      - name: Validate and fix Markdown files
        id: validate
        run: |
          set -e
          
          echo "ðŸ§¹ Cleaning up file encoding issues..."
          
          # Count initial issues
          ISSUE_COUNT=0
          
          # Process all Markdown files
          find content -name "*.md" -type f | while read -r file; do
            echo "ðŸ” Checking: $file"
            
            # Remove Byte Order Mark (BOM) if present
            sed -i '1s/^\xEF\xBB\xBF//' "$file"
            
            # Remove any leading whitespace from first line
            sed -i '1s/^[[:space:]]*//' "$file"
            
            # Read first line
            FIRST_LINE=$(head -n 1 "$file")
            
            # If file doesn't start with front matter delimiter, add it
            if [[ ! "$FIRST_LINE" =~ ^---$ ]] && [[ ! "$FIRST_LINE" =~ ^\+\+\+$ ]]; then
              echo "  âš ï¸  Missing front matter delimiter. Attempting to fix..."
              sed -i '1i ---' "$file"
              # Add closing delimiter at line 2 (temporary, will be validated)
              sed -i '2i ---' "$file"
              ISSUE_COUNT=$((ISSUE_COUNT + 1))
            fi
            
            # Extract front matter for validation
            TEMP_FILE=$(mktemp)
            if grep -q "^---" "$file"; then
              # Extract YAML front matter
              sed -n '/^---$/,/^---$/p' "$file" > "$TEMP_FILE"
            elif grep -q "^+++" "$file"; then
              # Extract TOML front matter
              sed -n '/^\+\+\+$/,/^\+\+\+$/p' "$file" > "$TEMP_FILE"
            fi
            
            # Validate front matter if we extracted it
            if [[ -s "$TEMP_FILE" ]]; then
              if grep -q "^---" "$TEMP_FILE"; then
                # Remove delimiters for YAML validation
                sed -i '1d; $d' "$TEMP_FILE"
                
                # Check if there's content between delimiters
                if [[ -s "$TEMP_FILE" ]]; then
                  # Validate YAML
                  if ! python3 -c "
import yaml, sys
try:
    with open('$TEMP_FILE', 'r') as f:
        yaml.safe_load(f)
    print('âœ… Valid YAML')
except Exception as e:
    print(f'âŒ Invalid YAML: {e}')
    sys.exit(1)
" > /dev/null 2>&1; then
                    echo "  âŒ Invalid YAML front matter in: $file"
                    echo "  ðŸ“ Front matter content:"
                    cat "$TEMP_FILE"
                    ISSUE_COUNT=$((ISSUE_COUNT + 1))
                  fi
                else
                  echo "  âš ï¸  Empty front matter in: $file"
                  ISSUE_COUNT=$((ISSUE_COUNT + 1))
                fi
              fi
            fi
            
            rm -f "$TEMP_FILE"
          done
          
          # Count total Markdown files
          TOTAL_FILES=$(find content -name "*.md" -type f | wc -l)
          
          if [[ $ISSUE_COUNT -gt 0 ]]; then
            echo "âš ï¸  Found $ISSUE_COUNT issues in $TOTAL_FILES Markdown files"
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "ISSUES=$ISSUE_COUNT" >> $GITHUB_OUTPUT
          else
            echo "âœ… All $TOTAL_FILES Markdown files validated successfully!"
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "ISSUES=0" >> $GITHUB_OUTPUT
          fi
          
          echo "TOTAL_FILES=$TOTAL_FILES" >> $GITHUB_OUTPUT

      - name: Show validation results
        if: always()
        run: |
          echo "Validation completed!"
          echo "Files with issues: ${{ steps.validate.outputs.ISSUES || 0 }}"
          echo "Total files checked: ${{ steps.validate.outputs.TOTAL_FILES || 0 }}"

  build:
    runs-on: ubuntu-latest
    needs: lint-and-validate
    if: needs.lint-and-validate.outputs.validation_passed == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: Install Hugo modules
        run: hugo mod tidy

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Test build (dry run)
        run: |
          echo "ðŸ§ª Testing Hugo build..."
          if ! hugo --verbose --buildDrafts --baseURL "https://example.com/" --destination /tmp/hugo-test; then
            echo "âŒ Build test failed!"
            echo "Trying to identify problematic files..."
            # Try to build each content directory separately
            find content -name "*.md" -type f | while read file; do
              if ! hugo --verbose --buildDrafts --contentDir "$(dirname "$file")" --baseURL "https://example.com/" > /tmp/hugo-error.log 2>&1; then
                echo "âš ï¸  Problematic file might be: $file"
                echo "Last error:"
                tail -20 /tmp/hugo-error.log
              fi
            done
            exit 1
          fi
          echo "âœ… Build test passed!"

      - name: Build with Hugo
        run: |
          echo "ðŸ—ï¸ Building site for production..."
          hugo --gc --minify --baseURL "${{ steps.pages.outputs.base_url }}/"
          echo "âœ… Build completed successfully!"

      - name: Validate generated site
        run: |
          echo "ðŸ” Validating generated site..."
          if [[ ! -f "public/index.html" ]]; then
            echo "âŒ No index.html generated!"
            exit 1
          fi
          
          # Check for broken links in generated site
          find public -name "*.html" -type f | head -5 | while read html_file; do
            echo "Checking: $html_file"
            # Simple validation: check for obvious issues
            if grep -q "nil" "$html_file"; then
              echo "âš ï¸  Found 'nil' in $html_file"
            fi
          done
          echo "âœ… Site validation passed!"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  report-failure:
    runs-on: ubuntu-latest
    needs: lint-and-validate
    if: failure() && needs.lint-and-validate.result == 'failure'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create validation report
        run: |
          echo "# ðŸš¨ Hugo Site Validation Report" > validation-report.md
          echo "## Failed on $(date)" >> validation-report.md
          echo "" >> validation-report.md
          echo "### Problematic files found:" >> validation-report.md
          echo "" >> validation-report.md
          
          # Find files with potential issues
          find content -name "*.md" -type f | while read file; do
            # Check for common issues
            if head -1 "$file" | grep -q "^\xEF\xBB\xBF"; then
              echo "- **$file**: Contains BOM (Byte Order Mark)" >> validation-report.md
            fi
            
            if ! head -1 "$file" | grep -q "^---\|^+++"; then
              echo "- **$file**: Missing front matter delimiter" >> validation-report.md
            fi
            
            # Try to extract and validate YAML
            if grep -q "^---" "$file"; then
              TEMP_FILE=$(mktemp)
              sed -n '/^---$/,/^---$/p' "$file" > "$TEMP_FILE"
              sed -i '1d; $d' "$TEMP_FILE"
              
              if python3 -c "
import yaml, sys
try:
    with open('$TEMP_FILE', 'r') as f:
        yaml.safe_load(f)
except Exception as e:
    print(f'YAML Error in $file: {e}')
    sys.exit(1)
" 2>&1 | grep -q "Error"; then
                ERROR=$(python3 -c "
import yaml, sys
try:
    with open('$TEMP_FILE', 'r') as f:
        yaml.safe_load(f)
except Exception as e:
    print(e)
")
                echo "- **$file**: YAML error - $ERROR" >> validation-report.md
              fi
              rm -f "$TEMP_FILE"
            fi
          done
          
          echo "" >> validation-report.md
          echo "### How to fix:" >> validation-report.md
          echo "1. Check the listed files for YAML syntax errors" >> validation-report.md
          echo "2. Ensure front matter starts with \`---\` on the first line" >> validation-report.md
          echo "3. Remove any special/invisible characters" >> validation-report.md
          echo "4. Validate YAML using https://www.yamllint.com/" >> validation-report.md
          
          cat validation-report.md

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: validation-report.md
